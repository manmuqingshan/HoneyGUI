(()=>{function t(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function e(t,e,n,r,o,a,i){try{var c=t[a](i),l=c.value}catch(t){n(t);return}c.done?e(l):Promise.resolve(l).then(r,o)}function n(t){return function(){var n=this,r=arguments;return new Promise(function(o,a){var i=t.apply(n,r);function c(t){e(i,o,a,c,l,"next",t)}function l(t){e(i,o,a,c,l,"throw",t)}c(void 0)})}}function r(e,n){return function(t){if(Array.isArray(t))return t}(e)||function(t,e){var n,r,o=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=o){var a=[],i=!0,c=!1;try{for(o=o.call(t);!(i=(n=o.next()).done)&&(a.push(n.value),!e||a.length!==e);i=!0);}catch(t){c=!0,r=t}finally{try{i||null==o.return||o.return()}finally{if(c)throw r}}return a}}(e,n)||function(e,n){if(e){if("string"==typeof e)return t(e,n);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return t(e,n)}}(e,n)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=c(0),i.throw=c(1),i.return=c(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(l){var u=[c,l];if(n)throw TypeError("Generator is already executing.");for(;i&&(i=0,u[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,r=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===u[0]||2===u[0])){a=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){a.label=u[1];break}if(6===u[0]&&a.label<o[1]){a.label=o[1],o=u;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(u);break}o[2]&&a.ops.pop(),a.trys.pop();continue}u=e.call(t,a)}catch(t){u=[6,t],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}}var a=[],i=new Set,c=new Set(["cellular","list","video"]);function l(t){return["RECTANGLE","LINE","ELLIPSE","POLYGON","STAR","VECTOR","BOOLEAN_OPERATION","GROUP"].includes(t.type)}function u(t){var e=[];if((f(t)||l(t))&&e.push(t),"children"in t&&"BOOLEAN_OPERATION"!==t.type&&"GROUP"!==t.type){var n=!0,r=!1,o=void 0;try{for(var a,i=t.children[Symbol.iterator]();!(n=(a=i.next()).done);n=!0){var c=a.value;e=e.concat(u(c))}}catch(t){r=!0,o=t}finally{try{n||null==i.return||i.return()}finally{if(r)throw o}}}return e}function s(t){return"".concat(t.name.replace(/[^a-z0-9_.-]/gi,"_"),".png")}function f(t){return"RECTANGLE"===t.type&&Array.isArray(t.fills)&&t.fills.some(function(t){return"IMAGE"===t.type})}pixso.showUI(__html__,{width:400,height:600}),pixso.ui.onmessage=function(t){return n(function(){var e,y,p,d,h,m,v,g,b,x,A,E,w,O,S;return o(this,function(M){switch(M.label){case 0:if(console.log("核心逻辑: 收到来自 UI 的消息",t),e=t,0===(y=pixso.currentPage.selection).length)return pixso.notify("请先在画板上选中至少一个图层。"),"generate-xml"===e.type&&pixso.ui.postMessage({type:"xml-generated",data:"\x3c!-- 请先在画板上选中至少一个图层。 --\x3e"}),[2];if("generate-xml"!==e.type)return[3,12];M.label=1;case 1:if(M.trys.push([1,10,,11]),0===(p=y.filter(function(t){return"FRAME"===t.type})).length)return pixso.notify("请选择一个或多个顶层画框 (Frame) 进行导出。"),pixso.ui.postMessage({type:"xml-generated",data:"\x3c!-- ".concat("请选择一个或多个顶层画框 (Frame) 进行导出。"," --\x3e")}),[2];d=new Set,a=[],i.clear(),h=`<?xml version="1.0" encoding="UTF-8"?>
`,m=!0,v=!1,g=void 0,M.label=2;case 2:M.trys.push([2,7,8,9]),b=p[Symbol.iterator](),M.label=3;case 3:if(m=(x=b.next()).done)return[3,6];return[4,function t(e,r,s,y,p){return n(function(){var n,d,h,m,v,g,b,x,A,E,w,O,S,M,N,I,T,R,C,P,_,L,G,j,U,z,X,F,Y,k,B,H,V,D,q,W,$,J,K,Q,Z,tt,te,tn,tr,to,ta,ti,tc,tl,tu,ts,tf,ty,tp,td,th,tm,tv,tg,tb,tx,tA,tE,tw,tO,tS,tM,tN;return o(this,function(o){switch(o.label){case 0:if(n=/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/,"FRAME"===e.type&&s){d=e.name.toLowerCase(),h=null,m=!0,v=!1,g=void 0;try{for(b=c[Symbol.iterator]();!(m=(x=b.next()).done);m=!0)if(A=x.value,d.includes(A)){h=A;break}}catch(t){v=!0,g=t}finally{try{m||null==b.return||b.return()}finally{if(v)throw g}}if(h){if("children"in e&&e.children){E=!0,w=!1,O=void 0;try{for(S=e.children[Symbol.iterator]();!(E=(M=S.next()).done);E=!0)N=M.value,(function t(e){if(Array.from(c).some(function(t){return e.name.toLowerCase().includes(t)}))return[];var n=[];if(!a.some(function(t){return t.id===e.id})&&(f(e)||l(e)))n.push(e);else if("INSTANCE"===e.type&&e.mainComponent){var r=e.mainComponent,o=r.parent,s=[];if(o&&"COMPONENT_SET"===o.type?(h=o.id,s=o.children):(h=r.id,s=[r]),!i.has(h)){i.add(h);var y=!0,p=!1,d=void 0;try{for(var h,m,v=s[Symbol.iterator]();!(y=(m=v.next()).done);y=!0){var g=m.value,b=u(g),x=!0,A=!1,E=void 0;try{for(var w,O=b[Symbol.iterator]();!(x=(w=O.next()).done);x=!0)!function(){var t=w.value;a.some(function(e){return e.id===t.id})||a.push(t)}()}catch(t){A=!0,E=t}finally{try{x||null==O.return||O.return()}finally{if(A)throw E}}}}catch(t){p=!0,d=t}finally{try{y||null==v.return||v.return()}finally{if(p)throw d}}}return n}if("children"in e&&e.children&&"BOOLEAN_OPERATION"!==e.type&&"GROUP"!==e.type){var S=!0,M=!1,N=void 0;try{for(var I,T=e.children[Symbol.iterator]();!(S=(I=T.next()).done);S=!0){var R=I.value;n=n.concat(t(R))}}catch(t){M=!0,N=t}finally{try{S||null==T.return||T.return()}finally{if(M)throw N}}}return n})(N).forEach(function(t){a.some(function(e){return e.id===t.id})||a.push(t)})}catch(t){w=!0,O=t}finally{try{E||null==S.return||S.return()}finally{if(w)throw O}}}return I=h.toUpperCase(),C=void 0===(R=(T=y||{}).offsetX)?0:R,_=void 0===(P=T.offsetY)?0:P,L=['x="'.concat(Math.round(e.x+C),'"'),'y="'.concat(Math.round(e.y+_),'"'),'w="'.concat(Math.round(e.width),'"'),'h="'.concat(Math.round(e.height),'"')],G=r+"  ",j=`
`.concat(G).concat(L.join(`
`+G)),U=e.name,n.test(e.name)&&p&&(U="widget",p.add("图层名含中文字符: '".concat(e.name,"' 请重命名"))),[2,"".concat(r,"<").concat(I).concat(j,">").concat(U.replace(/[<>&'"]/g,function(t){return({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[t]||t}),`
`)+"".concat(r,"</").concat(I,`>
`)]}}if(!("INSTANCE"===e.type&&e.mainComponent))return[3,3];if(X=(z=e.mainComponent).parent,Y=[],X&&"COMPONENT_SET"===X.type?(F=X.id,Y=X.children):(F=z.id,Y=[z]),!i.has(F)){i.add(F),k=!0,B=!1,H=void 0;try{for(V=Y[Symbol.iterator]();!(k=(D=V.next()).done);k=!0){q=D.value,W=u(q),$=!0,J=!1,K=void 0;try{for(Q=function(){var t=tt.value;a.some(function(e){return e.id===t.id})||a.push(t)},Z=W[Symbol.iterator]();!($=(tt=Z.next()).done);$=!0)Q()}catch(t){J=!0,K=t}finally{try{$||null==Z.return||Z.return()}finally{if(J)throw K}}}}catch(t){B=!0,H=t}finally{try{k||null==V.return||V.return()}finally{if(B)throw H}}}if(te="",!("children"in e&&e.children.length>0))return[3,2];return tn={offsetX:((null==y?void 0:y.offsetX)||0)+e.x,offsetY:((null==y?void 0:y.offsetY)||0)+e.y,reactions:"reactions"in e&&e.reactions.length>0?e.reactions:null==y?void 0:y.reactions},[4,Promise.all(e.children.map(function(e){return t(e,r,s,tn,p)}))];case 1:te=o.sent().join(""),o.label=2;case 2:return[2,te];case 3:if(ta=void 0===(to=(tr=y||{}).offsetX)?0:to,tc=void 0===(ti=tr.offsetY)?0:ti,tl=tr.reactions,tu=function(t){return t.replace(/[<>&'"]/g,function(t){return({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[t]||t})},tf=(ts=tl||("reactions"in e?e.reactions:[])).length>0,ty=f(e),tp=l(e),td=ty?"IMAGE":tp?tf?"CANVAS":"IMAGE":"FRAME"===e.type?s?"WIN":"SCREEN":e.type,th=['x="'.concat(Math.round(e.x+ta),'"'),'y="'.concat(Math.round(e.y+tc),'"'),'w="'.concat(Math.round(e.width),'"'),'h="'.concat(Math.round(e.height),'"')],"TEXT"!==e.type)return[3,6];if(!e.fontName)return[3,5];return[4,pixso.loadFontAsync(e.fontName)];case 4:o.sent(),tv=e.fontName.family.replace(/ /g,"_")+".bin",th.push('fontName="'.concat(tu(tv),'"')),o.label=5;case 5:var tI,tT;e.fontSize&&th.push('fontSize="'.concat(e.fontSize,'"')),Array.isArray(e.fills)&&(null==(tm=e.fills[0])?void 0:tm.type)==="SOLID"&&th.push('color="'.concat((tI=e.fills[0].color,tT=function(t){return Math.round(255*t).toString(16).padStart(2,"0")},"#".concat(tT(tI.r)).concat(tT(tI.g)).concat(tT(tI.b))),'"')),tg=e.characters.replace(/\n/g,"__NL__"),th.push('content="'.concat(tu(tg),'"')),tb="MID_CENTER","TOP"===e.textAlignVertical?tb=e.textAlignHorizontal:"CENTER"===e.textAlignVertical&&(tb="MID_"+e.textAlignHorizontal),th.push('style="'.concat(tb,'"')),o.label=6;case 6:if("IMAGE"===td&&(a.some(function(t){return t.id===e.id})||a.push(e),th.push('file="'.concat(e.name+".bin",'"')),"RECTANGLE"===e.type&&"PASS_THROUGH"===e.blendMode&&th.push('blendMode="imgSrcOverMode"')),tx=r+"  ",tA=`
`.concat(tx).concat(th.join(`
`+tx)),tE="".concat(r,"<").concat(td).concat(tA),tw="",ts.length>0&&ts.forEach(function(t){var e=t.action,n=t.trigger;if(n&&e&&e.destinationId){var r=['trigger="'.concat(n.type,'"')],o=tx+"  ",a=`
`.concat(o).concat(r.join(`
`.concat(o)));tw+="".concat(tx,"<REACTION").concat(a,`>
`).concat(tx,`</REACTION>
`)}}),tO="children"in e&&e.children.length>0&&"BOOLEAN_OPERATION"!==e.type&&"GROUP"!==e.type,tS=e.name,n.test(e.name)&&p&&(tS="widget",p.add("图层名含中文字符: '".concat(e.name,"' 请重命名"))),!(tO||tw))return[3,9];if(tE+=">".concat(tu(tS),`
`),tw&&(tE+=tw),!tO)return[3,8];return tM=s||"FRAME"===e.type,tN={offsetX:ta,offsetY:tc,reactions:"reactions"in e&&e.reactions.length>0?e.reactions:tl},[4,Promise.all(e.children.map(function(e){return t(e,r+"  ",tM,tN,p)}))];case 7:tE+=o.sent().join(""),o.label=8;case 8:return tE+="".concat(r,"</").concat(td,`>
`),[3,10];case 9:tE+=">".concat(tu(tS),`
`).concat(r,"</").concat(td,`>
`),o.label=10;case 10:return[2,tE]}})})()}(x.value,"",!1,void 0,d)];case 4:h+=M.sent(),M.label=5;case 5:return m=!0,[3,3];case 6:return[3,9];case 7:return A=M.sent(),v=!0,g=A,[3,9];case 8:try{m||null==b.return||b.return()}finally{if(v)throw g}return[7];case 9:return pixso.ui.postMessage({type:"xml-generated",data:h}),pixso.ui.postMessage({type:"images-discovered",count:a.length}),a.length>0&&(E=new Map,a.forEach(function(t){var e=s(t);E.set(e,(E.get(e)||0)+1)}),(w=Array.from(E.entries()).filter(function(t){return r(t,2)[1]>1}).map(function(t){return r(t,1)[0]})).length>0&&d.add("图片重名警告: ".concat(w.join(", ")," (导出时可能被覆盖)"))),d.size>0?(O=Array.from(d).join(`
`),pixso.notify(O,{timeout:8e3})):a.length>0&&pixso.notify("已识别出 ".concat(a.length," 张图片，现在可以导出了。")),[3,11];case 10:return console.error("核心逻辑: 生成 XML 时发生错误:",M.sent()),pixso.notify("生成 XML 失败，请查看开发者工具获取详情。"),[3,11];case 11:return[3,18];case 12:if("export-images"!==e.type)return[3,17];if(0===a.length)return pixso.notify("没有可导出的图片。请先点击“生成 XML”来查找图层中的图片。"),pixso.ui.postMessage({type:"zip-and-download",payload:[]}),[2];M.label=13;case 13:return M.trys.push([13,15,,16]),[4,Promise.all(a.map(function(t){return n(function(){var e;return o(this,function(n){switch(n.label){case 0:return[4,t.exportAsync({format:"PNG"})];case 1:return e=n.sent(),[2,{filename:s(t),data:e}]}})})()}))];case 14:return S=M.sent(),pixso.ui.postMessage({type:"zip-and-download",payload:S}),[3,16];case 15:return console.error("核心逻辑: 导出图片时发生错误:",M.sent()),pixso.notify("导出图片失败，请查看插件开发者工具获取详情。"),[3,16];case 16:return[3,18];case 17:"notify"===e.type&&pixso.notify(e.message,e.options||{}),M.label=18;case 18:return[2]}})})()}})();