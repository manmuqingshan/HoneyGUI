(function(s){typeof define=="function"&&define.amd?define(s):s()})((function(){"use strict";let s=[],M=new Set;const X=new Set(["cellular","list","video"]);mg.showUI(__html__),mg.ui.onmessage=async e=>{console.log("核心逻辑: 收到来自 UI 的消息",e);const c=mg.document.currentPage.selection;if(c.length===0){const i="请先在画板上选中至少一个图层。";mg.notify(i),e.pluginMessage.type==="generate-xml"&&mg.ui.postMessage({pluginMessage:{type:"xml-generated",data:"<!-- "+i+" -->"}});return}if(console.log(`msg.pluginMessage.type ${e.pluginMessage.type}`),e.pluginMessage.type==="generate-xml")try{const i=c.filter(a=>a.type==="FRAME");if(i.length===0){const a="请选择一个或多个顶层画框 (Frame) 进行导出。";mg.notify(a),mg.ui.postMessage({pluginMessage:{type:"xml-generated",data:`<!-- ${a} -->`}});return}const n=new Set;s=[],M.clear();let g=`<?xml version="1.0" encoding="UTF-8"?>
`;for(const a of i)g+=await x(a,"",!1,void 0,n);if(mg.ui.postMessage({pluginMessage:{type:"xml-generated",data:g}}),mg.ui.postMessage({pluginMessage:{type:"images-discovered",count:s.length}}),s.length>0){const a=new Map;s.forEach(p=>{const h=b(p);a.set(h,(a.get(h)||0)+1)});const N=Array.from(a.entries()).filter(([,p])=>p>1).map(([p])=>p);N.length>0&&n.add(`图片重名警告: ${N.join(", ")} (导出时可能被覆盖)`)}if(n.size>0){const a=Array.from(n).join(`
`);mg.notify(a,{timeout:8e3})}else s.length>0&&mg.notify(`已识别出 ${s.length} 张图片，现在可以导出了。`)}catch(i){console.error("核心逻辑: 生成 XML 时发生错误:",i),mg.notify("生成 XML 失败，请查看插件开发者工具获取详情。")}else if(e.pluginMessage.type==="export-images"){if(s.length===0){mg.notify("没有可导出的图片。请先点击“生成 XML”来查找图层中的图片。"),mg.ui.postMessage({pluginMessage:{type:"zip-and-download",payload:[]}});return}try{const i=await Promise.all(s.map(async n=>{const g=await n.exportAsync({format:"PNG"});return{filename:b(n),data:g}}));mg.ui.postMessage({pluginMessage:{type:"zip-and-download",payload:i}})}catch(i){console.error("核心逻辑: 导出图片时发生错误:",i),mg.notify("导出图片失败，请查看插件开发者工具获取详情。")}}else e.pluginMessage.type==="notify"&&mg.notify(e.message,e.options||{})};async function x(e,t,c,i,n){const g=/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/;if(e.type==="FRAME"&&c){const f=e.name.toLowerCase();let o=null;for(const r of X)if(f.includes(r)){o=r;break}if(o){if("children"in e&&e.children)for(const L of e.children)G(L).forEach(z=>{s.includes(z)||s.push(z)});const r=o.toUpperCase(),{offsetX:l=0,offsetY:u=0}=i||{},m=L=>L.replace(/[<>&'"]/g,F=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[F]||F),$=[`x="${Math.round(e.x+l)}"`,`y="${Math.round(e.y+u)}"`,`w="${Math.round(e.width)}"`,`h="${Math.round(e.height)}"`],A=t+"  ",D=`
${A}${$.join(`
`+A)}`;let P=e.name;g.test(e.name)&&n&&(P="widget",n.add(`图层名含中文字符: '${e.name}' 请重命名`));let U=`${t}<${r}${D}>${m(P)}
`;return U+=`${t}</${r}>
`,U}}if(e.type==="INSTANCE"&&e.mainComponent){const f=e.mainComponent,o=f.parent;let r,l=[];if(o&&o.type==="COMPONENT_SET"?(r=o.id,l=o.children):(r=f.id,l=[f]),!M.has(r)){M.add(r);for(const m of l){const $=R(m);for(const A of $)s.some(P=>P.id===A.id)||s.push(A)}}let u="";if("children"in e&&e.children.length>0){const m={offsetX:(i?.offsetX||0)+e.x,offsetY:(i?.offsetY||0)+e.y,reactions:"reactions"in e&&e.reactions.length>0?e.reactions:i?.reactions},$=e.children.map(A=>x(A,t,c,m,n));u=(await Promise.all($)).join("")}return u}const{offsetX:a=0,offsetY:N=0,reactions:p}=i||{},h=f=>f.replace(/[<>&'"]/g,o=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[o]||o),S=p||("reactions"in e?e.reactions:[]),B=S.length>0,Y=T(e),H=I(e);let y;Y?y="IMAGE":H?y=B?"CANVAS":"IMAGE":e.type==="FRAME"?y=c?"WIN":"SCREEN":y=e.type;const d=[`x="${Math.round(e.x+a)}"`,`y="${Math.round(e.y+N)}"`,`w="${Math.round(e.width)}"`,`h="${Math.round(e.height)}"`];if(e.type==="TEXT"){if(e.textStyles&&e.textStyles.length>0){const l=e.textStyles[0],u=l.textStyle.fontName;if(u){await mg.loadFontAsync(u);const m=u.family.replace(/ /g,"_")+".bin";d.push(`fontName="${h(m)}"`)}if(l.textStyle.fontSize&&d.push(`fontSize="${l.textStyle.fontSize}"`),Array.isArray(l.fills)){const m=l.fills.find($=>$.type==="SOLID");m&&d.push(`color="${j(m.color)}"`)}}const f=e.characters.replace(/\n/g,"__NL__");d.push(`content="${h(f)}"`);const o=e.textAlignHorizontal,r=e.textAlignVertical;var w="MID_CENTER";r==="TOP"?w=o:r==="CENTER"&&(w="MID_"+o),d.push(`style="${w}"`)}y==="IMAGE"&&(s.includes(e)||s.push(e),d.push(`file="${e.name+".bin"}"`),e.type==="RECTANGLE"&&e.blendMode==="PASS_THROUGH"&&d.push('blendMode="imgSrcOverMode"'));const C=t+"  ";let V=`
${C}${d.join(`
`+C)}`,E=`${t}<${y}${V}`,O="";S.length>0&&(console.log(e),S.forEach(f=>{const{action:o,trigger:r}=f;if(!r||!o||!o.destinationId)return;const l=[`trigger="${r.type}"`],u=C+"  ",m=`
${u}${l.join(`
${u}`)}`;O+=`${C}<REACTION${m}>
${C}</REACTION>
`}));const v="children"in e&&e.children.length>0&&e.type!=="BOOLEAN_OPERATION"&&e.type!=="GROUP";let _=e.name;if(g.test(e.name)&&n&&(_="widget",n.add(`图层名含中文字符: '${e.name}' 请重命名`)),v||O){if(E+=`>${h(_)}
`,O&&(E+=O),v){const f=c||e.type==="FRAME",o={offsetX:a,offsetY:N,reactions:"reactions"in e&&e.reactions.length>0?e.reactions:p},r=e.children.map(l=>x(l,t+"  ",f,o,n));E+=(await Promise.all(r)).join("")}E+=`${t}</${y}>
`}else E+=`>${h(_)}
${t}</${y}>
`;return E}function G(e){if(X.has(e.name.toLowerCase()))return console.log(e.name+" 节点被跳过"),[];let t=[];if(T(e)||I(e))t.push(e);else if(e.type==="INSTANCE"&&e.mainComponent){const c=e.mainComponent,i=c.parent;let n,g=[];if(i&&i.type==="COMPONENT_SET"?(n=i.id,g=i.children):(n=c.id,g=[c]),!M.has(n)){M.add(n);for(const a of g){const N=R(a);for(const p of N)s.some(S=>S.id===p.id)||s.push(p)}}return t}if("children"in e&&e.children&&e.type!=="BOOLEAN_OPERATION"&&e.type!=="GROUP")for(const c of e.children)t=t.concat(G(c));return t}function I(e){return["RECTANGLE","LINE","ELLIPSE","POLYGON","STAR","PEN","BOOLEAN_OPERATION","GROUP"].includes(e.type)}function j(e){const t=c=>Math.round(c*255).toString(16).padStart(2,"0");return`#${t(e.r)}${t(e.g)}${t(e.b)}`}function R(e){let t=[];return(T(e)||I(e))&&t.push(e),"children"in e&&e.type!=="BOOLEAN_OPERATION"&&e.type!=="GROUP"&&e.children.forEach(c=>{t=t.concat(R(c))}),t}function b(e){return`${e.name.replace(/[^a-z0-9_.-]/gi,"_")}.png`}function T(e){return e.type==="RECTANGLE"&&Array.isArray(e.fills)&&e.fills.some(t=>t.type==="IMAGE")}}));
