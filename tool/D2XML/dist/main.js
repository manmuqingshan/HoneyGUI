(function(n){typeof define=="function"&&define.amd?define(n):n()})((function(){"use strict";let n=[],O=new Set;const L=new Set(["cellular","list","video"]);mg.showUI(__html__),mg.ui.onmessage=async t=>{console.log("核心逻辑: 收到来自 UI 的消息",t);const c=mg.document.currentPage.selection;if(c.length===0){const a="请先在画板上选中至少一个图层。";mg.notify(a),t.pluginMessage.type==="generate-xml"&&mg.ui.postMessage({pluginMessage:{type:"xml-generated",data:"<!-- "+a+" -->"}});return}if(console.log(`msg.pluginMessage.type ${t.pluginMessage.type}`),t.pluginMessage.type==="generate-xml")try{const a=c.filter(r=>r.type==="FRAME");if(a.length===0){const r="请选择一个或多个顶层画框 (Frame) 进行导出。";mg.notify(r),mg.ui.postMessage({pluginMessage:{type:"xml-generated",data:`<!-- ${r} -->`}});return}const l=new Set;n=[],O.clear();let $=`<?xml version="1.0" encoding="UTF-8"?>
`;for(const r of a)$+=await C(r,"",!1,void 0,l);if(mg.ui.postMessage({pluginMessage:{type:"xml-generated",data:$}}),mg.ui.postMessage({pluginMessage:{type:"images-discovered",count:n.length}}),n.length>0){const r=new Map;n.forEach(u=>{const E=X(u);r.set(E,(r.get(E)||0)+1)});const M=Array.from(r.entries()).filter(([,u])=>u>1).map(([u])=>u);M.length>0&&l.add(`图片重名警告: ${M.join(", ")} (导出时可能被覆盖)`)}if(l.size>0){const r=Array.from(l).join(`
`);mg.notify(r,{timeout:8e3})}else n.length>0&&mg.notify(`已识别出 ${n.length} 张图片，现在可以导出了。`)}catch(a){console.error("核心逻辑: 生成 XML 时发生错误:",a),mg.notify("生成 XML 失败，请查看插件开发者工具获取详情。")}else if(t.pluginMessage.type==="export-images"){if(n.length===0){mg.notify("没有可导出的图片。请先点击“生成 XML”来查找图层中的图片。"),mg.ui.postMessage({pluginMessage:{type:"zip-and-download",payload:[]}});return}try{const a=await Promise.all(n.map(async l=>{const $=await l.exportAsync({format:"PNG"});return{filename:X(l),data:$}}));mg.ui.postMessage({pluginMessage:{type:"zip-and-download",payload:a}})}catch(a){console.error("核心逻辑: 导出图片时发生错误:",a),mg.notify("导出图片失败，请查看插件开发者工具获取详情。")}}else t.pluginMessage.type==="notify"&&mg.notify(t.message,t.options||{})};async function C(t,e,c,a,l){const $=/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/;if(t.type==="FRAME"&&c){const f=t.name.toLowerCase();let i=null;for(const s of L)if(f.includes(s)){i=s;break}if(i){if("children"in t&&t.children)for(const w of t.children)_(w).forEach(z=>{n.includes(z)||n.push(z)});const s=i.toUpperCase(),{offsetX:o=0,offsetY:p=0}=a||{},g=w=>w.replace(/[<>&'"]/g,T=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[T]||T),m=[`x="${Math.round(t.x+o)}"`,`y="${Math.round(t.y+p)}"`,`w="${Math.round(t.width)}"`,`h="${Math.round(t.height)}"`],x=e+"  ",V=`
${x}${m.join(`
`+x)}`;let G=t.name;$.test(t.name)&&l&&(G="widget",l.add(`图层名含中文字符: '${t.name}' 请重命名`));let v=`${e}<${s}${V}>${g(G)}
`;return v+=`${e}</${s}>
`,v}}if(t.type==="INSTANCE"&&t.mainComponent){const f=t.mainComponent,i=f.parent;let s,o=[];i&&i.type==="COMPONENT_SET"?(s=i.id,o=i.children):(s=f.id,o=[f]),O.has(s)||(O.add(s),o.forEach(g=>{F(g).forEach(m=>{N(m)&&!n.includes(m)&&n.push(m)})}));let p="";if("children"in t&&t.children.length>0){const g={offsetX:(a?.offsetX||0)+t.x,offsetY:(a?.offsetY||0)+t.y,reactions:"reactions"in t&&t.reactions.length>0?t.reactions:a?.reactions},m=t.children.map(x=>C(x,e,c,g,l));p=(await Promise.all(m)).join("")}return p}const{offsetX:r=0,offsetY:M=0,reactions:u}=a||{},E=f=>f.replace(/[<>&'"]/g,i=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[i]||i),P=u||("reactions"in t?t.reactions:[]),U=P.length>0,Y=N(t),H=j(t);let h;Y?h="IMAGE":H?h=U?"CANVAS":"IMAGE":t.type==="FRAME"?h=c?"WIN":"SCREEN":h=t.type;const y=[`x="${Math.round(t.x+r)}"`,`y="${Math.round(t.y+M)}"`,`w="${Math.round(t.width)}"`,`h="${Math.round(t.height)}"`];if(t.type==="TEXT"){if(t.textStyles&&t.textStyles.length>0){const o=t.textStyles[0],p=o.textStyle.fontName;if(p){await mg.loadFontAsync(p);const g=p.family.replace(/ /g,"_")+".bin";y.push(`fontName="${E(g)}"`)}if(o.textStyle.fontSize&&y.push(`fontSize="${o.textStyle.fontSize}"`),Array.isArray(o.fills)){const g=o.fills.find(m=>m.type==="SOLID");g&&y.push(`color="${B(g.color)}"`)}}const f=t.characters.replace(/\n/g,"__NL__");y.push(`content="${E(f)}"`);const i=t.textAlignHorizontal,s=t.textAlignVertical;var R="MID_CENTER";s==="TOP"?R=i:s==="CENTER"&&(R="MID_"+i),y.push(`style="${R}"`)}h==="IMAGE"&&(n.includes(t)||n.push(t),y.push(`file="${t.name+".bin"}"`),t.type==="RECTANGLE"&&t.blendMode==="PASS_THROUGH"&&y.push('blendMode="imgSrcOverMode"'));const d=e+"  ";let D=`
${d}${y.join(`
`+d)}`,A=`${e}<${h}${D}`,S="";P.length>0&&P.forEach(f=>{const{action:i,trigger:s}=f;if(!s||!i||!i.destinationId)return;const o=[`trigger="${s.type}"`],p=d+"  ",g=`
${p}${o.join(`
${p}`)}`;S+=`${d}<REACTION${g}>
${d}</REACTION>
`});const b="children"in t&&t.children.length>0&&t.type!=="BOOLEAN_OPERATION"&&t.type!=="GROUP";let I=t.name;if($.test(t.name)&&l&&(I="widget",l.add(`图层名含中文字符: '${t.name}' 请重命名`)),b||S){if(A+=`>${E(I)}
`,S&&(A+=S),b){const f=c||t.type==="FRAME",i={offsetX:r,offsetY:M,reactions:"reactions"in t&&t.reactions.length>0?t.reactions:u},s=t.children.map(o=>C(o,e+"  ",f,i,l));A+=(await Promise.all(s)).join("")}A+=`${e}</${h}>
`}else A+=`>${E(I)}
${e}</${h}>
`;return A}function _(t){if(L.has(t.name.toLowerCase()))return[];let e=[];if(N(t)&&e.push(t),"children"in t&&t.children&&t.type!=="BOOLEAN_OPERATION")for(const c of t.children)e=e.concat(_(c));return e}function j(t){return["RECTANGLE","LINE","ELLIPSE","POLYGON","STAR","PEN","BOOLEAN_OPERATION","GROUP"].includes(t.type)}function B(t){const e=c=>Math.round(c*255).toString(16).padStart(2,"0");return`#${e(t.r)}${e(t.g)}${e(t.b)}`}function F(t){let e=[];return N(t)&&e.push(t),"children"in t&&t.type!=="BOOLEAN_OPERATION"&&t.children.forEach(c=>{e=e.concat(F(c))}),e}function X(t){return`${t.name.replace(/[^a-z0-9_.-]/gi,"_")}.png`}function N(t){return t.type==="RECTANGLE"&&Array.isArray(t.fills)&&t.fills.some(e=>e.type==="IMAGE")}}));
