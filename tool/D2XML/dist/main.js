(function(a){typeof define=="function"&&define.amd?define(a):a()})((function(){"use strict";let a=[],d=new Set;const T=new Set(["cellular","list","video"]);mg.showUI(__html__),mg.ui.onmessage=async t=>{console.log("核心逻辑: 收到来自 UI 的消息",t);const o=mg.document.currentPage.selection;if(o.length===0){const n="请先在画板上选中至少一个图层。";mg.notify(n),t.pluginMessage.type==="generate-xml"&&mg.ui.postMessage({pluginMessage:{type:"xml-generated",data:"<!-- "+n+" -->"}});return}if(console.log(`msg.pluginMessage.type ${t.pluginMessage.type}`),t.pluginMessage.type==="generate-xml")try{a=[],d.clear();let n=`<?xml version="1.0" encoding="UTF-8"?>
`;for(const f of o)n+=await x(f,"",!1);if(mg.ui.postMessage({pluginMessage:{type:"xml-generated",data:n}}),mg.ui.postMessage({pluginMessage:{type:"images-discovered",count:a.length}}),a.length>0){const f=new Map;a.forEach(p=>{const $=L(p);f.set($,(f.get($)||0)+1)});const y=Array.from(f.entries()).filter(([,p])=>p>1).map(([p])=>p);y.length>0?mg.notify(`注意：发现同名图片，导出时可能被覆盖：${y.join(", ")}`,{timeout:8e3}):mg.notify(`已识别出 ${a.length} 张图片，现在可以导出了。`)}}catch(n){console.error("核心逻辑: 生成 XML 时发生错误:",n),mg.notify("生成 XML 失败，请查看插件开发者工具获取详情。")}else if(t.pluginMessage.type==="export-images"){if(a.length===0){mg.notify("没有可导出的图片。请先点击“生成 XML”来查找图层中的图片。"),mg.ui.postMessage({pluginMessage:{type:"zip-and-download",payload:[]}});return}try{const n=await Promise.all(a.map(async f=>{const y=await f.exportAsync({format:"PNG"});return{filename:L(f),data:y}}));mg.ui.postMessage({pluginMessage:{type:"zip-and-download",payload:n}})}catch(n){console.error("核心逻辑: 导出图片时发生错误:",n),mg.notify("导出图片失败，请查看插件开发者工具获取详情。")}}else t.pluginMessage.type==="notify"&&mg.notify(t.message,t.options||{})};async function x(t,e,o,n){if(t.type==="FRAME"&&o){const l=t.name.toLowerCase();let i=null;for(const s of T)if(l.includes(s)){i=s;break}if(i){if("children"in t&&t.children)for(const I of t.children)R(I).forEach(b=>{a.includes(b)||a.push(b)});const s=i.toUpperCase(),{offsetX:r=0,offsetY:g=0}=n||{},c=I=>I.replace(/[<>&'"]/g,P=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[P]||P),u=[`x="${Math.round(t.x+r)}"`,`y="${Math.round(t.y+g)}"`,`w="${Math.round(t.width)}"`,`h="${Math.round(t.height)}"`],S=e+"  ",j=`
${S}${u.join(`
`+S)}`;let X=`${e}<${s}${j}>${c(t.name)}
`;return X+=`${e}</${s}>
`,X}}if(t.type==="INSTANCE"&&t.mainComponent){const l=t.mainComponent,i=l.parent;let s,r=[];i&&i.type==="COMPONENT_SET"?(s=i.id,r=i.children):(s=l.id,r=[l]),d.has(s)||(d.add(s),r.forEach(c=>{w(c).forEach(u=>{A(u)&&!a.includes(u)&&a.push(u)})}));let g="";if("children"in t&&t.children.length>0){const c={offsetX:(n?.offsetX||0)+t.x,offsetY:(n?.offsetY||0)+t.y,reactions:"reactions"in t&&t.reactions.length>0?t.reactions:n?.reactions},u=t.children.map(S=>x(S,e,o,c));g=(await Promise.all(u)).join("")}return g}const{offsetX:f=0,offsetY:y=0,reactions:p}=n||{},$=l=>l.replace(/[<>&'"]/g,i=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[i]||i),O=p||("reactions"in t?t.reactions:[]),v=O.length>0,z=A(t),B=F(t);let h;h||(z?h="IMAGE":B?h=v?"CANVAS":"IMAGE":t.type==="FRAME"?h=o?"WIN":"SCREEN":h=t.type);const m=[`x="${Math.round(t.x+f)}"`,`y="${Math.round(t.y+y)}"`,`w="${Math.round(t.width)}"`,`h="${Math.round(t.height)}"`];if(t.type==="TEXT"){if(t.textStyles&&t.textStyles.length>0){const r=t.textStyles[0],g=r.textStyle.fontName;if(g){await mg.loadFontAsync(g);const c=g.family.replace(/ /g,"_")+".bin";m.push(`fontName="${$(c)}"`)}if(r.textStyle.fontSize&&m.push(`fontSize="${r.textStyle.fontSize}"`),Array.isArray(r.fills)){const c=r.fills.find(u=>u.type==="SOLID");c&&m.push(`color="${G(c.color)}"`)}}const l=t.characters.replace(/\n/g,"__NL__");m.push(`content="${$(l)}"`);const i=t.textAlignHorizontal,s=t.textAlignVertical;var C="MID_CENTER";s==="TOP"?C=i:s==="CENTER"&&(C="MID_"+i),m.push(`style="${C}"`)}h==="IMAGE"&&(a.includes(t)||a.push(t),m.push(`file="${t.name+".bin"}"`),t.type==="RECTANGLE"&&t.blendMode==="PASS_THROUGH"&&m.push('blendMode="imgSrcOverMode"'));const M=e+"  ";let Y=`
${M}${m.join(`
`+M)}`,E=`${e}<${h}${Y}`,N="";O.length>0&&O.forEach(l=>{const{action:i,trigger:s}=l;if(!s||!i||!i.destinationId)return;const r=[`trigger="${s.type}"`],g=M+"  ",c=`
${g}${r.join(`
${g}`)}`;N+=`${M}<REACTION${c}>
${M}</REACTION>
`});const _="children"in t&&t.children.length>0&&t.type!=="BOOLEAN_OPERATION";if(_||N){if(E+=`>${$(t.name)}
`,N&&(E+=N),_){const l=o||t.type==="FRAME",i={offsetX:f,offsetY:y,reactions:"reactions"in t&&t.reactions.length>0?t.reactions:p},s=t.children.map(r=>x(r,e+"  ",l,i));E+=(await Promise.all(s)).join("")}E+=`${e}</${h}>
`}else E+=`>${$(t.name)}
${e}</${h}>
`;return E}function R(t){if(T.has(t.name.toLowerCase()))return[];let e=[];if(A(t)&&e.push(t),"children"in t&&t.children&&t.type!=="BOOLEAN_OPERATION")for(const o of t.children)e=e.concat(R(o));return e}function F(t){return["RECTANGLE","LINE","ELLIPSE","POLYGON","STAR","PEN","BOOLEAN_OPERATION"].includes(t.type)}function G(t){const e=o=>Math.round(o*255).toString(16).padStart(2,"0");return`#${e(t.r)}${e(t.g)}${e(t.b)}`}function w(t){let e=[];return A(t)&&e.push(t),"children"in t&&t.type!=="BOOLEAN_OPERATION"&&t.children.forEach(o=>{e=e.concat(w(o))}),e}function L(t){return`${t.name.replace(/[^a-z0-9_.-]/gi,"_")}.png`}function A(t){return t.type==="RECTANGLE"&&Array.isArray(t.fills)&&t.fills.some(e=>e.type==="IMAGE")}}));
